<style>
    body.loading main { display: none; }
    body.loaded .loading { display: none; }
    .highlight { background: yellow; }
</style>

<body class="loading">
    <main>
        <h1>Jan 6 documents search</h1>
        <input type="text" id="search" />
        <!-- <input type="submit" /> -->
        <div id="results"></div>
    </main>
    <div class="loading">
        Loading...
    </div>

    <script src="https://unpkg.com/lunr/lunr.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js" integrity="sha512-g2TeAWw5GPnX7z0Kn8nFbYfeHcvAu/tx6d6mrLe/90mkCxO+RcptyYpksUz35EO337F83bZwcmUyHiHamspkfg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script>

// From https://gist.github.com/evenfrost/1ba123656ded32fb7a0cd4651efd4db0
const highlight = (fuseSearchResult, highlightClassName = 'highlight') => {
  const set = (obj, path, value) => {
      const pathValue = path.split('.');
      let i;

      for (i = 0; i < pathValue.length - 1; i++) {
        obj = obj[pathValue[i]];
      }

      obj[pathValue[i]] = value;
  };

  const generateHighlightedText = (inputText, regions = []) => {
    let content = '';
    let nextUnhighlightedRegionStartingIndex = 0;

    regions.forEach(region => {
      const lastRegionNextIndex = region[1] + 1;

      content += [
        inputText.substring(nextUnhighlightedRegionStartingIndex, region[0]),
        `<span class="${highlightClassName}">`,
        inputText.substring(region[0], lastRegionNextIndex),
        '</span>',
      ].join('');

      nextUnhighlightedRegionStartingIndex = lastRegionNextIndex;
    });

    content += inputText.substring(nextUnhighlightedRegionStartingIndex);

    return content;
  };

  return fuseSearchResult
    .filter(({ matches }) => matches && matches.length)
    .map(({ item, matches }) => {
      const highlightedItem = { ...item };

      matches.forEach((match) => {
        set(highlightedItem, match.key, generateHighlightedText(match.value, match.indices));
      });

      return highlightedItem;
    });
};


        Promise.all([fetch("content.json.gz"), fetch("idx.json.gz")]).then(e => e).then(async ([contentData, idxData]) => {
            const uncompressToJSON = async file => {
                const output = pako.inflate(await file.arrayBuffer());
                const blob = new Blob([output], {type: 'text/plain; charset=utf-8'});
                return JSON.parse(await blob.text());
            }
            const content = await uncompressToJSON(contentData);
            const idx = lunr.Index.load(await uncompressToJSON(idxData));
            window.idx = idx;
            window.content = content;
            document.body.classList.replace("loading", "loaded");
            document.getElementById("search").oninput = e => {
                const query = e.target.value;
                const initialResults = idx.search(query);
                const results = [];
                for (const result of initialResults) {
                    const {matchData, ref, score} = result;
                    const matchFields = Object.keys(matchData.metadata[Object.keys(matchData.metadata)[0]]);
                    const documentInfo = content[ref];
                    const { content: documentContent, ...restofDocumentInfo } = documentInfo;
                    // const fuse = new Fuse([{content: documentInfo.content}], {
                    //     keys: ['content'],
                    //     includeMatches: true
                    // });
                    const highlightedContent = "";
                    // const highlighted = highlight(fuse.search(query));
                    // const highlightedContent = highlighted[0] ? highlighted[0].content: '';
                    // const highlighted = "test";
                    results.push({
                        matchFields,
                        url: documentInfo.url,
                        title: documentInfo.title,
                        documentInfo: restofDocumentInfo,
                        highlightedContent,
                        score
                    });
                }
                document.getElementById("results").innerHTML = `${results.map(r => `
                    <div><strong>${r.title} (<a href="${r.url}">Link</a>)</strong><br>${r.highlightedContent}</div>
                  <br>`).join('')}`;
            }
        });
    </script>
</body>